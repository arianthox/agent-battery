generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                  String          @id @default(uuid())
  provider            String
  displayName         String
  orgWorkspaceId      String?
  authType            String
  syncEnabled         Boolean         @default(true)
  syncIntervalSeconds Int?
  credentialRef       String
  lastValidatedAt     DateTime?
  expiresAt           DateTime?
  status              String          @default("ok")
  lastError           String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  usageSnapshots      UsageSnapshot[]
  syncRuns            SyncRun[]
}

model UsageSnapshot {
  id             String   @id @default(uuid())
  accountId      String
  provider       String
  windowType     String
  windowStart    DateTime
  windowEnd      DateTime
  usedValue      Float
  usedUnit       String
  limitValue     Float
  limitUnit      String
  remainingValue Float
  batteryPercent Float
  confidence     String
  source         String
  fetchedAt      DateTime
  createdAt      DateTime @default(now())
  account        Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, fetchedAt])
}

model SyncRun {
  id           String    @id @default(uuid())
  accountId    String
  startedAt    DateTime
  finishedAt   DateTime?
  outcome      String
  errorCode    String?
  errorMessage String?
  attempts     Int       @default(0)
  nextRetryAt  DateTime?
  createdAt    DateTime  @default(now())
  account      Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId, startedAt])
}

model AppSettings {
  id                            String  @id @default("singleton")
  lowBatteryThresholdPercent    Int     @default(20)
  persistentFailureThreshold    Int     @default(3)
  defaultPollingIntervalSeconds Int     @default(120)
  debugLogsEnabled              Boolean @default(false)
}

model NotificationState {
  id             String   @id @default(uuid())
  accountId      String
  notificationKey String
  lastSentAt     DateTime

  @@unique([accountId, notificationKey])
}
